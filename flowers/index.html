<html><head><title>Flowers Tutorial</title>
    <style>
    body {
        font-family: Calibri, sans-serif;
        margin: 20px;
    }
    p {
        max-width: 600px;
        line-height: 1.4;
    }
    td {
        padding-right:10px
    }
    .code {
        font-family: Consolas, Monaco, Inconsolata, monospace;
        border-left: solid 5px #e7e7e7;
        color: #444;
        padding-left: 12px;
    }
    .inlinecode {
        font-family: Consolas, Monaco, Inconsolata, monospace;
        color: #444;
    }
    .console {
        font-family: Consolas, Monaco, Inconsolata, monospace;
        padding: 16px;
        background: #444;
        color: #eee;
        width: 700px;
    }
    .name {color:#d09}
    .call {color:#d60}
    .literal {color:#088}
    .comment {color:#444; background:#eee}
    .highlight {background:#ffc}
    .highlight .comment, .comment .highlight {background:#f0edd3}
    </style>
    </head>
    <body>
    <h1>Flowers</h1>
<h2><a href="flowers.love">Download flowers.love</a></h2>
<img src="1.png">
<h2>Rules</h2>
<p>The game starts with a grid of covered cells. Under some of the cells are flowers. The game is over when a flower is uncovered.</p>
<p>Left clicking a cell uncovers it, and if none of its adjacent cells contain flowers, they are also uncovered, and for <i>those</i> uncovered cells, if none of <i>their</i> adjacent cells contain flowers, they are also uncovered, and so on.</p>
<p>Right clicking a cell toggles between the cell having a flag, a question mark, or nothing. Flags prevent a cell from being uncovered with a left click. Question marks are visual markers which don't affect the game.</p>
<h2>Controls</h2>
<table>
<tr><td><b>Left click</b></td><td>Uncover a cell</td></tr>
<tr><td><b>Right click</b></td><td>Cycle a covered cell through having a flag, a question mark, or nothing</td></tr>
</table>
<h2>Overview</h2>
<p>The cells are represented by tables containing a boolean value indicating whether or not there is a flower under it, and a string value indicating which of four states the cell is in: covered, covered with a flag, covered with a question mark, or uncovered.</p>
<p>The cells which have flowers are chosen randomly. The first cell clicked is excluded from the possible options.</p>
<p>When a cell is clicked, its position is added to the "uncover stack" table.</p>
<p>While there is anything left on the uncover stack...</p>
<ul>
<li>A position is removed from the end of the stack.</li>
<li>This position is set to <b>uncovered</b>.</li>
<li>If there are no flowers surrounding this position, the surrounding <b>covered</b> and <b>question marked</b> positions are added to the uncover stack.</li>
</ul>
<p>The cells are drawn by assembling the following images:</p>
<img src="2.png">
<h2>Coding</h2>
<h3>Loading images</h3>
<p>All of the images needed for the game are loaded into a table.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="name">images</span> = {}
    for <span class="name">imageIndex</span>, <span class="name">image</span> in <span class="call">ipairs</span>({
        <span class="literal">1</span>, <span class="literal">2</span>, <span class="literal">3</span>, <span class="literal">4</span>, <span class="literal">5</span>, <span class="literal">6</span>, <span class="literal">7</span>, <span class="literal">8</span>,
        <span class="literal">'uncovered'</span>, <span class="literal">'covered_highlighted'</span>, <span class="literal">'covered'</span>, <span class="literal">'flower'</span>, <span class="literal">'flag'</span>, <span class="literal">'question'</span>,
    }) do
        <span class="name">images</span>[<span class="name">image</span>] = <span class="call">love.graphics.newImage</span>(<span class="literal">'images/'</span>..<span class="name">image</span>..<span class="literal">'.png'</span>)
    end
end
</pre>
<h3>Drawing tiles</h3>
<p>The covered cell image is drawn for every cell.</p>
<pre class="code">
function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="literal">14</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="literal">19</span> do
            local <span class="name">cellSize</span> = <span class="literal">18</span>
            <span class="call">love.graphics.draw</span>(<span class="name">images.covered</span>, (<span class="name">x</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>, (<span class="name">y</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>)
        end
    end
end
</pre>
<img src="3.png">
<h3>Selecting cells</h3>
<p>The cell position under the mouse is updated every frame.</p>
<p>This needs the cell size, so it is moved from <span class="inlinecode">
<span class="name">love.draw</span></span> to <span class="inlinecode">
<span class="name">love.load</span></span>.</p>
<p>For now, this position is drawn as text.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>    
    <span class="highlight"><span class="name">cellSize</span> = <span class="literal">18</span></span>
end

function <span class="name">love.update</span>()
    <span class="name">selectedX</span> = <span class="call">math.floor</span>(<span class="call">love.mouse.getX</span>() / <span class="name">cellSize</span>) + <span class="literal">1</span>
    <span class="name">selectedY</span> = <span class="call">math.floor</span>(<span class="call">love.mouse.getY</span>() / <span class="name">cellSize</span>) + <span class="literal">1</span>
end

function <span class="name">love.draw</span>()
    <span class="comment">-- etc.
</span>
    <span class="comment">-- Removed: local cellSize = 18
</span>
    <span class="comment">-- Temporary
</span>    <span class="call">love.graphics.setColor</span>(<span class="literal">0</span>, <span class="literal">0</span>, <span class="literal">0</span>)
    <span class="call">love.graphics.print</span>(<span class="literal">'selected x: '</span>..<span class="name">selectedX</span>..<span class="literal">' selected y: '</span>..<span class="name">selectedY</span>)
    <span class="call">love.graphics.setColor</span>(<span class="literal">255</span>, <span class="literal">255</span>, <span class="literal">255</span>)
end
</pre>
<img src="4.png">
<h3>Keeping selected cell within grid</h3>
<p>If the mouse is greater than the grid's X or Y cell count (i.e. it is off the right or bottom of the grid) the selected position is set to the last cell in that direction.</p>
<p>The grid's X and Y cell count is reused from drawing the cells, so variables are made for them.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>
    <span class="name">gridXCount</span> = <span class="literal">19</span>
    <span class="name">gridYCount</span> = <span class="literal">14</span>
end

function <span class="name">love.update</span>()
    <span class="name">selectedX</span> = <span class="call">math.floor</span>(<span class="call">love.mouse.getX</span>() / <span class="name">cellSize</span>) + <span class="literal">1</span>
    <span class="name">selectedY</span> = <span class="call">math.floor</span>(<span class="call">love.mouse.getY</span>() / <span class="name">cellSize</span>) + <span class="literal">1</span>

    <span class="highlight">if <span class="name">selectedX</span> > <span class="name">gridXCount</span> then</span>
    <span class="highlight">    <span class="name">selectedX</span> = <span class="name">gridXCount</span></span>
    <span class="highlight">end</span>
    <span class="highlight">if <span class="name">selectedY</span> > <span class="name">gridYCount</span> then</span>
    <span class="highlight">    <span class="name">selectedY</span> = <span class="name">gridYCount</span></span>
    <span class="highlight">end</span>
end

function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="highlight"><span class="name">gridYCount</span></span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="highlight"><span class="name">gridXCount</span></span> do

        <span class="comment">-- etc.
</span>end
</pre>
<img src="5.png">
<h3>Highlighting cells</h3>
<p>The selected cell is a drawn with a different highlighted image.</p>
<pre class="code">
function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            <span class="highlight">local <span class="name">image</span></span>

            <span class="highlight">if <span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span> then</span>
            <span class="highlight">    <span class="name">image</span> = <span class="name">images.covered_highlighted</span></span>
            <span class="highlight">else</span>
            <span class="highlight">    <span class="name">image</span> = <span class="name">images.covered</span></span>
            <span class="highlight">end</span>

            <span class="call">love.graphics.draw</span>(<span class="highlight"><span class="name">image</span></span>, (<span class="name">x</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>, (<span class="name">y</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>)
        end
    end
end
</pre>
<img src="6.png">
<h3>Change cell image when left mouse button is down</h3>
<p>When the left mouse button is down the selected cell is drawn as an uncovered cell.</p>
<pre class="code">
function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            local <span class="name">image</span>

            if <span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span> then
                <span class="highlight">if <span class="call">love.mouse.isDown</span>(<span class="literal">1</span>) then</span>
                <span class="highlight">    <span class="name">image</span> = <span class="name">images.uncovered</span></span>
                <span class="highlight">else</span>
                    <span class="name">image</span> = <span class="name">images.covered_highlighted</span>
                <span class="highlight">end</span>
            else
                <span class="name">image</span> = <span class="name">images.covered</span>
            end

            <span class="call">love.graphics.draw</span>(<span class="name">image</span>, (<span class="name">x</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>, (<span class="name">y</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>)
        end
    end
end
</pre>
<img src="7.png">
<h3>Drawing flowers</h3>
<p>A grid is created to store the state of the cells. Because each cell will have two values which need to be stored (whether it has a flower, and whether it is uncovered, has a flag, a question mark, or nothing) each cell is represented by a table.</p>
<p>If a cell's <span class="inlinecode">
<span class="literal">'flower'</span></span> key is true, the flower image is drawn over the cell image.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>
    <span class="name">grid</span> = {}
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        <span class="name">grid</span>[<span class="name">y</span>] = {}
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>] = {
                <span class="name">flower</span> = <span class="literal">false</span>,
            }
        end
    end

    <span class="comment">-- Temporary
</span>    <span class="name">grid</span>[<span class="literal">1</span>][<span class="literal">1</span>].<span class="name">flower</span> = <span class="literal">true</span>
    <span class="name">grid</span>[<span class="literal">1</span>][<span class="literal">2</span>].<span class="name">flower</span> = <span class="literal">true</span>
end
 
function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            <span class="comment">-- etc.
</span>            
            <span class="highlight">if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> then</span>
            <span class="highlight">    <span class="call">love.graphics.draw</span>(<span class="name">images.flower</span>, (<span class="name">x</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>, (<span class="name">y</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>)</span>
            <span class="highlight">end</span>
        end
    end
end
</pre>
<img src="8.png">
<h3>Simplifying code</h3>
<p>The code for drawing covered cells and drawing the flower is the same except for the image to draw, so a function is created with the image and the needed X and Y values as parameters.</p>
<pre class="code">
function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            <span class="highlight">local function <span class="name">drawCell</span>(<span class="name">image</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
                <span class="call">love.graphics.draw</span>(<span class="name">image</span>, (<span class="name">x</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>, (<span class="name">y</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>)
            <span class="highlight">end</span>
            
            if <span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span> then
                if <span class="call">love.mouse.isDown</span>(<span class="literal">1</span>) then
                    <span class="highlight"><span class="call">drawCell</span>(<span class="name">images.uncovered</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
                else
                    <span class="highlight"><span class="call">drawCell</span>(<span class="name">images.covered_highlighted</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
                end
            else
                <span class="highlight"><span class="call">drawCell</span>(<span class="name">images.covered</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
            end

            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> then
                <span class="highlight"><span class="call">drawCell</span>(<span class="name">images.flower</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
            end
        end
    end
end
</pre>
<h3>Toggling flowers</h3>
<p>For testing, right clicking a cell will toggle its flower.</p>
<pre class="code">
function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if <span class="name">button</span> == <span class="literal">2</span> then
        <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">flower</span> = not <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">flower</span>
    end
end
</pre>
<h3>Showing surrounding flower count</h3>
<p>To find the surrounding flower count, each position in the 8 directions around each cell is looped through, and if there is a cell at this position (i.e. the position on the grid is not nil) and there is a flower at this cell then 1 is added to the surrounding flower count.</p>
<p>If the surrounding flower count is greater than 0, the appropriate number image is drawn over the cell.</p>
<pre class="code">
function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            local function <span class="name">drawCell</span>(<span class="name">image</span>, <span class="name">x</span>, <span class="name">y</span>)
                <span class="call">love.graphics.draw</span>(<span class="name">image</span>, (<span class="name">x</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>, (<span class="name">y</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>)
            end

            if <span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span> then
                if <span class="call">love.mouse.isDown</span>(<span class="literal">1</span>) then
                    <span class="call">drawCell</span>(<span class="name">images.uncovered</span>, <span class="name">x</span>, <span class="name">y</span>)
                else
                    <span class="call">drawCell</span>(<span class="name">images.covered_highlighted</span>, <span class="name">x</span>, <span class="name">y</span>)
                end
            else
                <span class="call">drawCell</span>(<span class="name">images.covered</span>, <span class="name">x</span>, <span class="name">y</span>)
            end

            <span class="highlight">local <span class="name">surroundingFlowerCount</span> = <span class="literal">0</span></span>

            <span class="highlight">for <span class="name">dy</span> = -<span class="literal">1</span>, <span class="literal">1</span> do</span>
            <span class="highlight">    for <span class="name">dx</span> = -<span class="literal">1</span>, <span class="literal">1</span> do</span>
            <span class="highlight">        if not (<span class="name">dy</span> == <span class="literal">0</span> and <span class="name">dx</span> == <span class="literal">0</span>)</span>
            <span class="highlight">        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>]</span>
            <span class="highlight">        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>]</span>
            <span class="highlight">        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">flower</span> then</span>
            <span class="highlight">            <span class="name">surroundingFlowerCount</span> = <span class="name">surroundingFlowerCount</span> + <span class="literal">1</span></span>
            <span class="highlight">        end</span>
            <span class="highlight">    end</span>
            <span class="highlight">end</span>

            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> then
                <span class="call">drawCell</span>(<span class="name">images.flower</span>, <span class="name">x</span>, <span class="name">y</span>)
            <span class="highlight">elseif <span class="name">surroundingFlowerCount</span> > <span class="literal">0</span> then</span>
            <span class="highlight">    <span class="call">drawCell</span>(<span class="name">images</span>[<span class="name">surroundingFlowerCount</span>], <span class="name">x</span>, <span class="name">y</span>)</span>
            end
        end
    end
end
</pre>
<img src="9.png">
<h3>Random flower placement</h3>
<p>A table is created containing every X and Y position in the grid.</p>
<p>Random positions are repeatedly removed from this table and the cells at these positions are set to have a flower.</p>
<p>To test this, any key calls <span class="inlinecode">
<span class="name">love.load</span></span>.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>
    local <span class="name">possibleFlowerPositions</span> = {}
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            <span class="call">table.insert</span>(<span class="name">possibleFlowerPositions</span>, {<span class="name">x</span> = <span class="name">x</span>, <span class="name">y</span> = <span class="name">y</span>})
        end
    end

    for <span class="name">flowerIndex</span> = <span class="literal">1</span>, <span class="literal">40</span> do
        local <span class="name">position</span> = <span class="call">table.remove</span>(<span class="name">possibleFlowerPositions</span>, <span class="call">love.math.random</span>(#<span class="name">possibleFlowerPositions</span>))
        <span class="name">grid</span>[<span class="name">position.y</span>][<span class="name">position.x</span>].<span class="name">flower</span> = <span class="literal">true</span>
    end
end

function <span class="name">love.keypressed</span>()
    <span class="comment">-- Temporary
</span>    <span class="call">love.load</span>()
end
</pre>
<img src="10.png">
<h3>Uncovering cells</h3>
<p>The cell tables are given a new key for the state of the cell as a string. For now, this is whether the cell is covered or uncovered.</p>
<p>For now, when a cell is left clicked its state is set to <span class="inlinecode">
<span class="literal">'uncovered'</span></span>.</p>
<p>If a cell's state is <span class="inlinecode">
<span class="literal">'uncovered'</span></span> the uncovered image is drawn instead of the covered images.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>
    <span class="name">grid</span> = {}
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        <span class="name">grid</span>[<span class="name">y</span>] = {}
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>] = {
                <span class="name">flower</span> = <span class="literal">false</span>,
                <span class="highlight"><span class="name">state</span> = <span class="literal">'covered'</span>, <span class="comment">-- 'covered', 'uncovered'</span>
</span>            }
        end
    end
end

function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if <span class="name">button</span> == <span class="literal">1</span> then
        <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'uncovered'</span>
    end
end

function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            <span class="comment">-- etc.
</span>
            <span class="highlight">if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'uncovered'</span> then</span>
            <span class="highlight">    <span class="call">drawCell</span>(<span class="name">images.uncovered</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
            <span class="highlight">else</span>
                if <span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span> then
                    if <span class="call">love.mouse.isDown</span>(<span class="literal">1</span>) then
                        <span class="call">drawCell</span>(<span class="name">images.uncovered</span>, <span class="name">x</span>, <span class="name">y</span>)
                    else
                        <span class="call">drawCell</span>(<span class="name">images.covered_highlighted</span>, <span class="name">x</span>, <span class="name">y</span>)
                    end
                else
                    <span class="call">drawCell</span>(<span class="name">images.covered</span>, <span class="name">x</span>, <span class="name">y</span>)
                end
            <span class="highlight">end</span>

            <span class="comment">-- etc.
</span>        end
    end
end
</pre>
<img src="11.png">
<h3>Flood fill: uncover stack</h3>
<p>Instead of uncovering a single cell, a stack of cells is created to uncover.</p>
<p>While there are positions in the uncover stack, a position is removed from it and the cell at this position on the grid is uncovered.</p>
<p>This stacks starts with just the selected position. More positions will be added to it later, but for now it will just contain the selected position, so it will only uncover the selected cell like before.</p>
<pre class="code">
function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if <span class="name">button</span> == <span class="literal">1</span> then
        local <span class="name">stack</span> = {
            {
                <span class="name">x</span> = <span class="name">selectedX</span>,
                <span class="name">y</span> = <span class="name">selectedY</span>,
            }
        }

        while #<span class="name">stack</span> > <span class="literal">0</span> do
            local <span class="name">current</span> = <span class="call">table.remove</span>(<span class="name">stack</span>)
            local <span class="name">x</span> = <span class="name">current.x</span>
            local <span class="name">y</span> = <span class="name">current.y</span>

            <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> = <span class="literal">'uncovered'</span>
        end
    end
end
</pre>
<h3>Flood fill: adding to the stack</h3>
<p>Each position in the 8 directions around each cell is looped through, and if there is a cell at this position (i.e. the position on the grid is not nil) and it is covered, then, for now, it added to the uncover stack.</p>
<p>This results in all of the cells becoming uncovered.</p>
<pre class="code">
function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if <span class="name">button</span> == <span class="literal">1</span> then
        local <span class="name">stack</span> = {
            {
                <span class="name">x</span> = <span class="name">selectedX</span>,
                <span class="name">y</span> = <span class="name">selectedY</span>,
            }
        }

        while #<span class="name">stack</span> > <span class="literal">0</span> do
            local <span class="name">current</span> = <span class="call">table.remove</span>(<span class="name">stack</span>)
            local <span class="name">x</span> = <span class="name">current.x</span>
            local <span class="name">y</span> = <span class="name">current.y</span>

            <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> = <span class="literal">'uncovered'</span>

            <span class="highlight">for <span class="name">dy</span> = -<span class="literal">1</span>, <span class="literal">1</span> do</span>
            <span class="highlight">    for <span class="name">dx</span> = -<span class="literal">1</span>, <span class="literal">1</span> do</span>
            <span class="highlight">        if not (<span class="name">dx</span> == <span class="literal">0</span> and <span class="name">dy</span> == <span class="literal">0</span>)</span>
            <span class="highlight">        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>]</span>
            <span class="highlight">        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>]</span>
            <span class="highlight">        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">state</span> == <span class="literal">'covered'</span> then</span>
            <span class="highlight">            <span class="call">table.insert</span>(</span>
            <span class="highlight">                <span class="name">stack</span>, {</span>
            <span class="highlight">                    <span class="name">x</span> = <span class="name">x</span> + <span class="name">dx</span>,</span>
            <span class="highlight">                    <span class="name">y</span> = <span class="name">y</span> + <span class="name">dy</span></span>
            <span class="highlight">                }</span>
            <span class="highlight">            )</span>
            <span class="highlight">        end</span>
            <span class="highlight">    end</span>
            <span class="highlight">end</span>
        end
    end
end
</pre>
<img src="12.png">
<h3>Flood fill: using surrounding flower count</h3>
<p>The surrounding cells of a position removed from the uncover stack are only added to the stack if none of the surrounding cells have flowers.</p>
<p>Finding the number of surrounding flowers is reused from drawing this number, so a function is made.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>
    <span class="highlight">function <span class="name">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>)</span>
        local <span class="name">surroundingFlowerCount</span> = <span class="literal">0</span>

        for <span class="name">dy</span> = -<span class="literal">1</span>, <span class="literal">1</span> do
            for <span class="name">dx</span> = -<span class="literal">1</span>, <span class="literal">1</span> do
                if not (<span class="name">dy</span> == <span class="literal">0</span> and <span class="name">dx</span> == <span class="literal">0</span>)
                and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>]
                and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>]
                and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">flower</span>
                then
                    <span class="name">surroundingFlowerCount</span> = <span class="name">surroundingFlowerCount</span> + <span class="literal">1</span>
                end
            end
        end

        <span class="highlight">return <span class="name">surroundingFlowerCount</span></span>
    <span class="highlight">end</span>
end

function <span class="name">love.draw</span>()
            <span class="comment">-- etc.
</span>
            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> then
                <span class="call">drawCell</span>(<span class="name">images.flower</span>, <span class="name">x</span>, <span class="name">y</span>)
            elseif <span class="highlight"><span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>)</span> > <span class="literal">0</span> then
                <span class="call">drawCell</span>(<span class="name">images</span>[<span class="highlight"><span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>)</span>], <span class="name">x</span>, <span class="name">y</span>)
            end
        end
    end
end

function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if <span class="name">button</span> == <span class="literal">1</span> then
        local <span class="name">stack</span> = {
            {
                <span class="name">x</span> = <span class="name">selectedX</span>,
                <span class="name">y</span> = <span class="name">selectedY</span>,
            }
        }

        while #<span class="name">stack</span> > <span class="literal">0</span> do
            local <span class="name">current</span> = <span class="call">table.remove</span>(<span class="name">stack</span>)
            local <span class="name">x</span> = <span class="name">current.x</span>
            local <span class="name">y</span> = <span class="name">current.y</span>

            <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> = <span class="literal">'uncovered'</span>

            <span class="highlight">if <span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>) == <span class="literal">0</span> then</span>
                for <span class="name">dy</span> = -<span class="literal">1</span>, <span class="literal">1</span> do
                    for <span class="name">dx</span> = -<span class="literal">1</span>, <span class="literal">1</span> do
                        if not (<span class="name">dx</span> == <span class="literal">0</span> and <span class="name">dy</span> == <span class="literal">0</span>)
                        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>]
                        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>]
                        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">state</span> == <span class="literal">'covered'</span> then
                            <span class="call">table.insert</span>(
                                <span class="name">stack</span>, {
                                    <span class="name">x</span> = <span class="name">x</span> + <span class="name">dx</span>,
                                    <span class="name">y</span> = <span class="name">y</span> + <span class="name">dy</span>
                                }
                            )
                        end
                    end
                end
            <span class="highlight">end</span>
        end
    end
end
</pre>
<img src="13.png">
<h3>Drawing flags and question marks</h3>
<p>A cell's state can also be a flag or a question mark.</p>
<p>If a cell's state is a flag/question mark, the flag/question mark image is drawn over the cell.</p>
<p>To test this, the state of two cells are changed to have a flag and to have a question mark.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>
    <span class="name">grid</span> = {}
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        <span class="name">grid</span>[<span class="name">y</span>] = {}
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>] = {
                <span class="name">flower</span> = <span class="literal">false</span>,
                <span class="name">state</span> = <span class="literal">'covered'</span>, <span class="comment">-- 'covered', 'uncovered', <span class="highlight">'flag', 'question'</span>
</span>            }
        end
    end

    <span class="highlight"><span class="comment">-- Temporary</span>
</span>    <span class="highlight"><span class="name">grid</span>[<span class="literal">1</span>][<span class="literal">1</span>].<span class="name">state</span> = <span class="literal">'flag'</span></span>
    <span class="highlight"><span class="name">grid</span>[<span class="literal">1</span>][<span class="literal">2</span>].<span class="name">state</span> = <span class="literal">'question'</span></span>

    <span class="comment">-- etc.
</span>end

function <span class="name">love.draw</span>()
            <span class="comment">-- etc.
</span>
            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> then
                <span class="call">drawCell</span>(<span class="name">images.flower</span>, <span class="name">x</span>, <span class="name">y</span>)
            elseif <span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>) > <span class="literal">0</span> then
                <span class="call">drawCell</span>(<span class="name">images</span>[<span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>)], <span class="name">x</span>, <span class="name">y</span>)
            end

            <span class="highlight">if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'flag'</span> then</span>
            <span class="highlight">    <span class="call">drawCell</span>(<span class="name">images.flag</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
            <span class="highlight">elseif <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'question'</span> then</span>
            <span class="highlight">    <span class="call">drawCell</span>(<span class="name">images.question</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
            <span class="highlight">end</span>
        end
    end
end
</pre>
<img src="14.png">
<h3>Cycling flags and question marks</h3>
<p>Right clicking a cell cycles its state through having nothing, a flag, and a question mark.</p>
<pre class="code">
function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if <span class="name">button</span> == <span class="literal">1</span> then
        <span class="comment">-- etc.
</span>
    elseif <span class="name">button</span> == <span class="literal">2</span> then
        if <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> == <span class="literal">'covered'</span> then
            <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'flag'</span>
        elseif <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> == <span class="literal">'flag'</span> then
            <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'question'</span>
        elseif <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> == <span class="literal">'question'</span> then
            <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'covered'</span>
        end
    end
end
</pre>
<h3>Prevent uncovering flags</h3>
<p>If a cell has a flag it can't be uncovered by a left click.</p>
<pre class="code">
function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if <span class="name">button</span> == <span class="literal">1</span> <span class="highlight">and <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> ~= <span class="literal">'flag'</span></span> then
        <span class="comment">-- etc.
</span>    end
end
</pre>
<h3>Question marks don't stop fill</h3>
<p>Positions are added to the uncover stack if the cell's state is covered or a question mark (but not a flag).</p>
<pre class="code">
function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
                        <span class="comment">-- etc.
</span>
                        if not (<span class="name">dx</span> == <span class="literal">0</span> and <span class="name">dy</span> == <span class="literal">0</span>)
                        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>]
                        and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>]
                        and <span class="highlight">(</span>
                            <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">state</span> == <span class="literal">'covered'</span>
                            <span class="highlight">or <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">state</span> == <span class="literal">'question'</span></span>
                        <span class="highlight">)</span> then
                            <span class="call">table.insert</span>(<span class="name">stack</span>, {
                                    <span class="name">x</span> = <span class="name">x</span> + <span class="name">dx</span>,
                                    <span class="name">y</span> = <span class="name">y</span> + <span class="name">dy</span>
                                }
                            )
                        
                        <span class="comment">-- etc.
</span>end
</pre>
<h3>Change cell image when left mouse button is down over flag</h3>
<p>If the left mouse button is down when the mouse is on a cell with a flag, the cell is drawn with the covered image.</p>
<pre class="code">
function <span class="name">love.draw</span>()
                <span class="comment">-- etc. 
</span>
                if <span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span> then
                    if <span class="call">love.mouse.isDown</span>(<span class="literal">1</span>) then
                        <span class="highlight">if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'flag'</span> then</span>
                        <span class="highlight">    <span class="call">drawCell</span>(<span class="name">images.covered</span>, <span class="name">x</span>, <span class="name">y</span>)</span>
                        <span class="highlight">else</span>
                            <span class="call">drawCell</span>(<span class="name">images.uncovered</span>, <span class="name">x</span>, <span class="name">y</span>)
                        <span class="highlight">end</span>
                    else
                        <span class="call">drawCell</span>(<span class="name">images.covered_highlighted</span>, <span class="name">x</span>, <span class="name">y</span>)
                    end
                    
                <span class="comment">-- etc.
</span>end
</pre>
<h3>Game over</h3>
<p>If a flower is uncovered the game is over.</p>
<p>A variable is made to store whether the game is over or not.</p>
<p>For now, if the game is over clicking cells does nothing.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>
    <span class="name">gameOver</span> = <span class="literal">false</span>
end

function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    <span class="highlight">if not <span class="name">gameOver</span> then</span>
        if <span class="name">button</span> == <span class="literal">1</span> and <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> ~= <span class="literal">'flag'</span> then
            <span class="highlight">if <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">flower</span> then</span>
            <span class="highlight">    <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'uncovered'</span></span>
            <span class="highlight">    <span class="name">gameOver</span> = <span class="literal">true</span></span>
            <span class="highlight">else</span>
                local <span class="name">stack</span> = {
                    {
                        <span class="name">x</span> = <span class="name">selectedX</span>,
                        <span class="name">y</span> = <span class="name">selectedY</span>,
                    }
                }

                <span class="comment">-- etc.
</span>            <span class="highlight">end</span>
        end
    <span class="highlight">end</span>
end
</pre>
<h3>Game won</h3>
<p>If there are no cells which are covered and don't have a flower, then the game is won.</p>
<pre class="code">
function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if not <span class="name">gameOver</span> then
        if <span class="name">button</span> == <span class="literal">1</span> and <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> ~= <span class="literal">'flag'</span> then
            <span class="comment">-- etc.
</span>
            if <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">flower</span> then
                <span class="comment">-- etc.
</span>            else
                <span class="comment">-- etc.
</span>
                <span class="highlight">local <span class="name">complete</span> = <span class="literal">true</span></span>

                <span class="highlight">for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do</span>
                <span class="highlight">    for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do</span>
                <span class="highlight">        if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> ~= <span class="literal">'uncovered'</span> and not <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> then</span>
                <span class="highlight">            <span class="name">complete</span> = <span class="literal">false</span></span>
                <span class="highlight">        end</span>
                <span class="highlight">    end</span>
                <span class="highlight">end</span>

                <span class="highlight">if <span class="name">complete</span> then</span>
                <span class="highlight">    <span class="name">gameOver</span> = <span class="literal">true</span></span>
                <span class="highlight">end</span>
            end
        end
    end
end
</pre>
<h3>New game on next click</h3>
<p>When the mouse is clicked when the game is over, the game is reset.</p>
<p>For now, <span class="inlinecode">
<span class="name">love.load</span></span> is called to reset the game.</p>
<pre class="code">
function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if not <span class="name">gameOver</span> then
        <span class="comment">-- etc.
</span>    <span class="highlight">else</span>
    <span class="highlight">    <span class="call">love.load</span>()</span>
    end
end
</pre>
<h3>Don't highlight when game over</h3>
<p>When the game is over the mouse no longer highlights cells.</p>
<pre class="code">
function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do

            <span class="comment">-- etc.
</span>
            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'uncovered'</span> then
                <span class="call">drawCell</span>(<span class="name">images.uncovered</span>, <span class="name">x</span>, <span class="name">y</span>)
            else
                if <span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span> <span class="highlight">and not <span class="name">gameOver</span></span> then

            <span class="comment">-- etc.
</span>end
</pre>
<h3>Hide flowers until game is over</h3>
<p>The flowers aren't drawn until the game is over.</p>
<pre class="code">
function <span class="name">love.draw</span>()
            <span class="comment">-- etc.
</span>
            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> <span class="highlight">and <span class="name">gameOver</span></span> <span class="name">the</span>
                <span class="call">drawCell</span>(<span class="name">images.flower</span>, <span class="name">x</span>, <span class="name">y</span>)

            <span class="comment">-- etc.
</span>end
</pre>
<img src="15.png">
<h3>Hide numbers for covered cells</h3>
<p>If a cell is not uncovered then its surrounding flower count is not shown.</p>
<pre class="code">
function <span class="name">love.draw</span>()
            <span class="comment">-- etc.
</span>
            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> and <span class="name">gameOver</span> then
                <span class="call">drawCell</span>(<span class="name">images.flower</span>, <span class="name">x</span>, <span class="name">y</span>)
            elseif <span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>) > <span class="literal">0</span> <span class="highlight">and <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'uncovered'</span></span> then
                <span class="call">drawCell</span>(<span class="name">images</span>[<span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>)], <span class="name">x</span>, <span class="name">y</span>)
            end

            <span class="comment">-- etc.
</span>end
</pre>
<img src="16.png">
<h3>Preventing clicking on flower on the first click</h3>
<p>So that the first click doesn't uncover a flower, the code for placing flowers is moved so that it runs when the mouse is clicked, and the cell under the mouse cursor is not added to the possible flower positions.</p>
<p>A variable is created to store whether a click is the first click of the game.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="comment">-- etc.
</span>
    <span class="name">firstClick</span> = <span class="literal">true</span>
end

function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if not <span class="name">gameOver</span> then
        if <span class="name">button</span> == <span class="literal">1</span> and <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> ~= <span class="literal">'flag'</span> then
            <span class="highlight">if <span class="name">firstClick</span> then</span>
                <span class="highlight"><span class="name">firstClick</span> = <span class="literal">false</span></span>

                local <span class="name">possibleFlowerPositions</span> = {}
                for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
                    for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
                        <span class="highlight">if not (<span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span>) then</span>
                            <span class="call">table.insert</span>(<span class="name">possibleFlowerPositions</span>, {<span class="name">x</span> = <span class="name">x</span>, <span class="name">y</span> = <span class="name">y</span>})
                        <span class="highlight">end</span>
                    end
                end

                for <span class="name">flowerIndex</span> = <span class="literal">1</span>, <span class="literal">40</span> do
                    local <span class="name">position</span> = <span class="call">table.remove</span>(<span class="name">possibleFlowerPositions</span>, <span class="call">love.math.random</span>(#<span class="name">possibleFlowerPositions</span>))
                    <span class="name">grid</span>[<span class="name">position.y</span>][<span class="name">position.x</span>].<span class="name">flower</span> = <span class="literal">true</span>
                end
            <span class="highlight">end</span>

            if <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">flower</span> then
                <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'uncovered'</span>
                <span class="name">gameOver</span> = <span class="literal">true</span>
            else

            <span class="comment">-- etc.
</span>end
</pre>
<h3>Resetting</h3>
<p>When the game is over only some variables need to be reset, so a function is made.</p>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="name">images</span> = {}
    for <span class="name">imageIndex</span>, <span class="name">image</span> in <span class="call">ipairs</span>({
        <span class="comment">-- etc.
</span>    }) do
        <span class="comment">-- etc.
</span>    end
    
    <span class="name">cellSize</span> = <span class="literal">18</span>
    
    <span class="name">gridXCount</span> = <span class="literal">19</span>
    <span class="name">gridYCount</span> = <span class="literal">14</span>

    function <span class="name">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>)
        <span class="comment">-- etc.
</span>    end

    <span class="highlight">function <span class="name">reset</span>()</span>
        <span class="name">grid</span> = {}
        for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
            <span class="name">grid</span>[<span class="name">y</span>] = {}
            for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
                <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>] = {
                    <span class="name">flower</span> = <span class="literal">false</span>,
                    <span class="name">state</span> = <span class="literal">'covered'</span>, <span class="comment">-- 'covered', 'uncovered', 'flag', 'question'
</span>                }
            end
        end

        <span class="name">gameOver</span> = <span class="literal">false</span>
        <span class="name">firstClick</span> = <span class="literal">true</span>
    <span class="highlight">end</span>

    <span class="highlight"><span class="call">reset</span>()</span>
end

function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if not <span class="name">gameOver</span> then
        <span class="comment">-- etc.
</span>    else
        <span class="highlight"><span class="call">reset</span>()</span>
    end
end
</pre>
<h2>Final code</h2>
<pre class="code">
function <span class="name">love.load</span>()
    <span class="name">images</span> = {}
    for <span class="name">imageIndex</span>, <span class="name">image</span> in <span class="call">ipairs</span>({
        <span class="literal">1</span>, <span class="literal">2</span>, <span class="literal">3</span>, <span class="literal">4</span>, <span class="literal">5</span>, <span class="literal">6</span>, <span class="literal">7</span>, <span class="literal">8</span>,
        <span class="literal">'uncovered'</span>, <span class="literal">'covered_highlighted'</span>, <span class="literal">'covered'</span>, <span class="literal">'flower'</span>, <span class="literal">'flag'</span>, <span class="literal">'question'</span>,
    }) do
        <span class="name">images</span>[<span class="name">image</span>] = <span class="call">love.graphics.newImage</span>(<span class="literal">'images/'</span>..<span class="name">image</span>..<span class="literal">'.png'</span>)
    end
    
    <span class="name">cellSize</span> = <span class="literal">18</span>
    
    <span class="name">gridXCount</span> = <span class="literal">19</span>
    <span class="name">gridYCount</span> = <span class="literal">14</span>

    function <span class="name">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>)
        local <span class="name">surroundingFlowerCount</span> = <span class="literal">0</span>

        for <span class="name">dy</span> = -<span class="literal">1</span>, <span class="literal">1</span> do
            for <span class="name">dx</span> = -<span class="literal">1</span>, <span class="literal">1</span> do
                if not (<span class="name">dy</span> == <span class="literal">0</span> and <span class="name">dx</span> == <span class="literal">0</span>)
                and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>]
                and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>]
                and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">flower</span> then
                    <span class="name">surroundingFlowerCount</span> = <span class="name">surroundingFlowerCount</span> + <span class="literal">1</span>
                end
            end
        end

        return <span class="name">surroundingFlowerCount</span>
    end

    function <span class="name">reset</span>()
        <span class="name">grid</span> = {}
        for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
            <span class="name">grid</span>[<span class="name">y</span>] = {}
            for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
                <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>] = {
                    <span class="name">flower</span> = <span class="literal">false</span>,
                    <span class="name">state</span> = <span class="literal">'covered'</span>, <span class="comment">-- 'covered', 'uncovered', 'flag', 'question'
</span>                }
            end
        end

        <span class="name">gameOver</span> = <span class="literal">false</span>
        <span class="name">firstClick</span> = <span class="literal">true</span>
    end

    <span class="call">reset</span>()
end

function <span class="name">love.update</span>()
    <span class="name">selectedX</span> = <span class="call">math.floor</span>(<span class="call">love.mouse.getX</span>() / <span class="name">cellSize</span>) + <span class="literal">1</span>
    <span class="name">selectedY</span> = <span class="call">math.floor</span>(<span class="call">love.mouse.getY</span>() / <span class="name">cellSize</span>) + <span class="literal">1</span>

    if <span class="name">selectedX</span> > <span class="name">gridXCount</span> then
        <span class="name">selectedX</span> = <span class="name">gridXCount</span>
    end
    if <span class="name">selectedY</span> > <span class="name">gridYCount</span> then
        <span class="name">selectedY</span> = <span class="name">gridYCount</span>
    end
end

function <span class="name">love.draw</span>()
    for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
        for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
            local function <span class="name">drawCell</span>(<span class="name">image</span>, <span class="name">x</span>, <span class="name">y</span>)
                <span class="call">love.graphics.draw</span>(<span class="name">image</span>, (<span class="name">x</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>, (<span class="name">y</span> - <span class="literal">1</span>) * <span class="name">cellSize</span>)
            end

            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'uncovered'</span> then
                <span class="call">drawCell</span>(<span class="name">images.uncovered</span>, <span class="name">x</span>, <span class="name">y</span>)
            else
                if <span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span> and not <span class="name">gameOver</span> then
                    if <span class="call">love.mouse.isDown</span>(<span class="literal">1</span>) then
                        if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'flag'</span> then
                            <span class="call">drawCell</span>(<span class="name">images.covered</span>, <span class="name">x</span>, <span class="name">y</span>)
                        else
                            <span class="call">drawCell</span>(<span class="name">images.uncovered</span>, <span class="name">x</span>, <span class="name">y</span>)
                        end
                    else
                        <span class="call">drawCell</span>(<span class="name">images.covered_highlighted</span>, <span class="name">x</span>, <span class="name">y</span>)
                    end
                else
                    <span class="call">drawCell</span>(<span class="name">images.covered</span>, <span class="name">x</span>, <span class="name">y</span>)
                end
            end
            
            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">flower</span> and <span class="name">gameOver</span> then
                <span class="call">drawCell</span>(<span class="name">images.flower</span>, <span class="name">x</span>, <span class="name">y</span>)
            elseif <span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>) > <span class="literal">0</span> and <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'uncovered'</span> then
                <span class="call">drawCell</span>(<span class="name">images</span>[<span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>)], <span class="name">x</span>, <span class="name">y</span>)
            end

            if <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'flag'</span> then
                <span class="call">drawCell</span>(<span class="name">images.flag</span>, <span class="name">x</span>, <span class="name">y</span>)
            elseif <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> == <span class="literal">'question'</span> then
                <span class="call">drawCell</span>(<span class="name">images.question</span>, <span class="name">x</span>, <span class="name">y</span>)
            end
        end
    end
end

function <span class="name">love.mousereleased</span>(<span class="name">mouseX</span>, <span class="name">mouseY</span>, <span class="name">button</span>)
    if not <span class="name">gameOver</span> then
        if <span class="name">button</span> == <span class="literal">1</span> and <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> ~= <span class="literal">'flag'</span> then
            if <span class="name">firstClick</span> then
                <span class="name">firstClick</span> = <span class="literal">false</span>

                local <span class="name">possibleFlowerPositions</span> = {}
                for <span class="name">y</span> = <span class="literal">1</span>, <span class="name">gridYCount</span> do
                    for <span class="name">x</span> = <span class="literal">1</span>, <span class="name">gridXCount</span> do
                        if not (<span class="name">x</span> == <span class="name">selectedX</span> and <span class="name">y</span> == <span class="name">selectedY</span>) then
                            <span class="call">table.insert</span>(<span class="name">possibleFlowerPositions</span>, {<span class="name">x</span> = <span class="name">x</span>, <span class="name">y</span> = <span class="name">y</span>})
                        end
                    end
                end

                for <span class="name">flowerIndex</span> = <span class="literal">1</span>, <span class="literal">40</span> do
                    local <span class="name">position</span> = <span class="call">table.remove</span>(<span class="name">possibleFlowerPositions</span>, <span class="call">love.math.random</span>(#<span class="name">possibleFlowerPositions</span>))
                    <span class="name">grid</span>[<span class="name">position.y</span>][<span class="name">position.x</span>].<span class="name">flower</span> = <span class="literal">true</span>
                end
            end

            if <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">flower</span> then
                <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'uncovered'</span>
                <span class="name">gameOver</span> = <span class="literal">true</span>
            else
                local <span class="name">stack</span> = {
                    {
                        <span class="name">x</span> = <span class="name">selectedX</span>,
                        <span class="name">y</span> = <span class="name">selectedY</span>,
                    }
                }

                while #<span class="name">stack</span> > <span class="literal">0</span> do
                    local <span class="name">current</span> = <span class="call">table.remove</span>(<span class="name">stack</span>)
                    local <span class="name">x</span> = <span class="name">current.x</span>
                    local <span class="name">y</span> = <span class="name">current.y</span>

                    <span class="name">grid</span>[<span class="name">y</span>][<span class="name">x</span>].<span class="name">state</span> = <span class="literal">'uncovered'</span>

                    if <span class="call">getSurroundingFlowerCount</span>(<span class="name">x</span>, <span class="name">y</span>) == <span class="literal">0</span> then
                        for <span class="name">dy</span> = -<span class="literal">1</span>, <span class="literal">1</span> do
                            for <span class="name">dx</span> = -<span class="literal">1</span>, <span class="literal">1</span> do
                                if not (<span class="name">dx</span> == <span class="literal">0</span> and <span class="name">dy</span> == <span class="literal">0</span>)
                                and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>]
                                and <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>]
                                and (
                                    <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">state</span> == <span class="literal">'covered'</span>
                                    or <span class="name">grid</span>[<span class="name">y</span> + <span class="name">dy</span>][<span class="name">x</span> + <span class="name">dx</span>].<span class="name">state</span> == <span class="literal">'question'</span>
                                ) then
                                    <span class="call">table.insert</span>(
                                        <span class="name">stack</span>, {
                                            <span class="name">x</span> = <span class="name">x</span> + <span class="name">dx</span>,
                                            <span class="name">y</span> = <span class="name">y</span> + <span class="name">dy</span>
                                        }
                                    )
                                end
                            end
                        end
                    end
                end
            end
        elseif <span class="name">button</span> == <span class="literal">2</span> then
            if <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> == <span class="literal">'covered'</span> then
                <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'flag'</span>
            elseif <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> == <span class="literal">'flag'</span> then
                <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'question'</span>
            elseif <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> == <span class="literal">'question'</span> then
                <span class="name">grid</span>[<span class="name">selectedY</span>][<span class="name">selectedX</span>].<span class="name">state</span> = <span class="literal">'covered'</span>
            end
        end
    else
        <span class="call">reset</span>()
    end
end
</pre>
</body></html>
